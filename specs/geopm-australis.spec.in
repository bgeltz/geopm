%define pname geopm
%define PNAME GEOPM

%define install_prefix /opt/%{pname}/%{pname}-%{version}
%define local_sitelib /lib/python%{python3_version}
%define module_prefix /opt/geopm/modulefiles/%{pname}
%define module_name %{version}

Name:          %{pname}
Summary:       Global Extensible Open Power Manager
Version:       @VERSION@
Release:       1
License:       BSD-3-Clause
Group:         System Environment/Libraries
URL:           https://geopm.github.io
Source0:       geopm.tar.gz
Source1:       geopm-service.tar.gz
BuildRequires: gcc-c++
BuildRequires: unzip
BuildRequires: libtool
BuildRequires: openssh
BuildRequires: libelf-devel
BuildRequires: geopm-service-devel
BuildRequires: python3
BuildRequires: python3-devel
BuildRequires: python-rpm-macros
Prefix:        %{install_prefix}

%description
@BLURB@

%prep

%setup -q -n %{pname}-%{version}

%package devel
Summary: Global Extensible Open Power Manager - development
Group: Development/Libraries
Requires: geopmpolicy

%description devel
Development package for GEOPM.

%package -n python3-geopmpy
Summary: Global Extensible Open Power Manager - python %{python_major_version}
Group: System Environment/Libraries
Requires: geopmpolicy
Requires: python3-geopmdpy
Provides: python3-geopmpy

%description -n python3-geopmpy
Python 3 package for GEOPM's HPC Runtime.

%build
test -f configure || ./autogen.sh
CC=icc CXX=icpc FC=ifort F77=ifort \
./configure --prefix=%{install_prefix} --libdir=%{install_prefix}/lib64 \
            --with-python=%{__python3} \
            --with-bash-completion-dir=%{install_prefix}/share/bash-completion/completions \
            --disable-geopmd-local \
            || ( cat config.log && false )

%{__make} %{?_smp_mflags}

%install
%{__python3} -m pip install --ignore-installed \
                            --target=%{buildroot}%{install_prefix}%{local_sitelib} \
                            -r ./scripts/requirements.txt
%{__install} -d %{buildroot}%{install_prefix}
%{__make} DESTDIR=%{buildroot} install
rm -f $(find %{buildroot}%{install_prefix} -name '*.a'; \
        find %{buildroot}%{install_prefix} -name '*.la')

# %{_rpmconfigdir}/brp-compress %{install_prefix}
# rm -f %{buildroot}%{install_prefix}/share/man/man1/*.1
# rm -f %{buildroot}%{install_prefix}/share/man/man3/*.3
# rm -f %{buildroot}%{install_prefix}/share/man/man7/*.7

# Module file - TODO this needs top be updated to a TCL module
%{__mkdir_p} %{buildroot}%{module_prefix}
%{__cat} << EOF > %{buildroot}/%{module_prefix}/%{module_name}
#%Module1.0#####################################################################

proc ModulesHelp { } {

puts stderr " "
puts stderr "This module loads the %{pname} package built with the intel compiler"
puts stderr "toolchain and the mpich MPI stack."
puts stderr "\nVersion %{version}\n"

}
module-whatis "Name: %{pname}"
module-whatis "Version: %{version}"
module-whatis "Category: perftools"
module-whatis "Description: %{summary}"
module-whatis "URL: %{url}"

set     version             %{version}

prepend-path    PATH                    %{install_prefix}/bin
prepend-path    PYTHONPATH              %{install_prefix}%{local_sitelib}
prepend-path    INCLUDE                 %{install_prefix}/include
prepend-path    LD_LIBRARY_PATH         %{install_prefix}/lib
prepend-path    MANPATH                 %{install_prefix}/share/man

setenv          %{PNAME}_DIR            %{install_prefix}
setenv          %{PNAME}_BIN            %{install_prefix}/bin
setenv          %{PNAME}_LIB            %{install_prefix}/lib
setenv          %{PNAME}_INC            %{install_prefix}/include

prereq oneapi
prereq mpich

EOF

%clean

%post
/sbin/ldconfig

%preun

%postun
/sbin/ldconfig

%files
%defattr(-,root,root,-)
%{install_prefix}/lib64/*
%{install_prefix}/bin/*
%{install_prefix}/share/man/*
%{install_prefix}/share/doc/geopm/*
%{install_prefix}/share/bash-completion/*
%{module_prefix}/%{module_name}

%files devel
%defattr(-,root,root,-)
%{install_prefix}/include/*

%files -n python3-geopmpy
%defattr(-,root,root,-)
%{install_prefix}%{local_sitelib}/*
%doc %{install_prefix}/share/man/man7/geopmpy.7
%changelog
@CHANGELOG@
